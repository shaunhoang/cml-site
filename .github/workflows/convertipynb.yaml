name: Convert Notebooks to Hugo MD

on:
  push:
    branches:
      - main
    paths:
      - '**.ipynb'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert-notebooks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install jupyter nbconvert nbformat

      - name: Convert Notebooks to Markdown
        shell: python
        run: |
          import os
          import re
          import nbformat
          from nbconvert import MarkdownExporter
          from traitlets.config import Config
          from datetime import datetime

          # --- CONFIGURATION ---
          # Add directories to exclude from the search
          EXCLUDE_DIRS = {'.git', '.github', '.ipynb_checkpoints', 'node_modules', 'public', 'resources'}
          
          def get_front_matter(title):
              """Generates the YAML preamble."""
              date_str = datetime.now().strftime("%Y-%m-%d")
              return f"""---
          title: "{title}"
          date: {date_str}
          draft: false
          ---
          
          """

          def convert_notebooks():
              print("Starting notebook conversion scan...")
              c = Config()
              c.MarkdownExporter.extract_output = True
              exporter = MarkdownExporter(config=c)
              
              count = 0
              for root, dirs, files in os.walk("."):
                  dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]

                  for file in files:
                      if file.endswith(".ipynb"):
                          count += 1
                          notebook_path = os.path.join(root, file)
                          print(f"[{count}] Found: {notebook_path}")

                          base_name = os.path.splitext(file)[0]
                          
                          # Output directly to the same folder as the ipynb
                          output_folder = root
                          
                          try:
                              with open(notebook_path, 'r', encoding='utf-8') as f:
                                  nb = nbformat.read(f, as_version=4)
                              
                              (body, resources) = exporter.from_notebook_node(nb)

                              # --- POST-PROCESSING ---
                              # Wrap Python code blocks in <details> tags for hide/unhide functionality
                              # We use regex to find fenced code blocks starting with ```python
                              print("    -> Adding code hide/unhide toggles...")
                              body = re.sub(
                                  r'(```python[\s\S]*?```)', 
                                  r'<details>\n<summary>Show Code</summary>\n\n\1\n\n</details>', 
                                  body
                              )

                              # Write Images
                              if 'outputs' in resources:
                                  for filename, data in resources['outputs'].items():
                                      img_path = os.path.join(output_folder, filename)
                                      with open(img_path, 'wb') as f_img:
                                          f_img.write(data)

                              output_file_path = os.path.join(output_folder, "index.md")
                              clean_title = base_name.replace('_', ' ').replace('-', ' ').title()
                              front_matter = get_front_matter(clean_title)

                              with open(output_file_path, 'w', encoding='utf-8') as f_out:
                                  f_out.write(front_matter + body)
                              
                              print(f"    -> Converted to: {output_file_path}")

                          except Exception as e:
                              print(f"    !! ERROR converting {notebook_path}: {e}")

              print(f"Scan complete. Processed {count} notebooks.")

          if __name__ == "__main__":
              convert_notebooks()

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-convert .ipynb to Hugo Markdown [skip ci]"
            git pull --rebase --autostash
            git push
          fi